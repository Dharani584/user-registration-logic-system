{% extends "base.html" %}

{% block title %}Dashboard - User Registration System{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <div class="welcome-section">
                <h1>Welcome back, {{ user.username }}!</h1>
                <p class="welcome-subtitle">Here's what's happening with your account today.</p>
            </div>
            <div class="header-actions">
                <a href="{{ url_for('main.profile') }}" class="btn btn-outline">
                    <i class="fas fa-user"></i>
                    View Profile
                </a>
                <a href="{{ url_for('main.settings') }}" class="btn btn-outline">
                    <i class="fas fa-cog"></i>
                    Settings
                </a>
            </div>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div class="dashboard-content">
        <div class="dashboard-grid">
            <!-- User Info Card -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h3><i class="fas fa-user-circle"></i> Account Information</h3>
                </div>
                <div class="card-body">
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Username</label>
                            <span>{{ user.username }}</span>
                        </div>
                        <div class="info-item">
                            <label>Email Address</label>
                            <span>{{ user.email }}</span>
                        </div>
                        <div class="info-item">
                            <label>User ID</label>
                            <span>#{{ user.user_id }}</span>
                        </div>
                        <div class="info-item">
                            <label>Account Status</label>
                            <span class="status-badge status-active">Active</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions Card -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                </div>
                <div class="card-body">
                    <div class="quick-actions">
                        <a href="{{ url_for('main.profile') }}" class="action-item">
                            <div class="action-icon">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="action-content">
                                <h4>Edit Profile</h4>
                                <p>Update your personal information</p>
                            </div>
                        </a>
                        
                        <a href="{{ url_for('main.settings') }}" class="action-item">
                            <div class="action-icon">
                                <i class="fas fa-key"></i>
                            </div>
                            <div class="action-content">
                                <h4>Change Password</h4>
                                <p>Update your account password</p>
                            </div>
                        </a>
                        
                        <a href="#" class="action-item" onclick="showAccountActivity(); return false;">
                            <div class="action-icon">
                                <i class="fas fa-history"></i>
                            </div>
                            <div class="action-content">
                                <h4>Account Activity</h4>
                                <p>View your recent login history</p>
                            </div>
                        </a>
                        
                        <a href="#" class="action-item" onclick="exportUserData(); return false;">
                            <div class="action-icon">
                                <i class="fas fa-download"></i>
                            </div>
                            <div class="action-content">
                                <h4>Export Data</h4>
                                <p>Download your account information</p>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Security Card -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h3><i class="fas fa-shield-alt"></i> Security Overview</h3>
                </div>
                <div class="card-body">
                    <div class="security-items">
                        <div class="security-item">
                            <div class="security-icon security-good">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="security-content">
                                <h4>Password Strength</h4>
                                <p>Your password meets security requirements</p>
                            </div>
                        </div>
                        
                        <div class="security-item">
                            <div class="security-icon security-good">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="security-content">
                                <h4>Session Security</h4>
                                <p>You are logged in securely</p>
                            </div>
                        </div>
                        
                        <div class="security-item">
                            <div class="security-icon security-warning">
                                <i class="fas fa-exclamation"></i>
                            </div>
                            <div class="security-content">
                                <h4>Two-Factor Authentication</h4>
                                <p>2FA is not enabled (recommended)</p>
                                <button class="btn btn-sm btn-outline" onclick="enable2FA()">
                                    Enable 2FA
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Card -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h3><i class="fas fa-chart-bar"></i> Account Statistics</h3>
                </div>
                <div class="card-body">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number">
                                <i class="fas fa-calendar-alt"></i>
                                <span>Member Since</span>
                            </div>
                            <div class="stat-label">Today</div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-number">
                                <i class="fas fa-sign-in-alt"></i>
                                <span>Total Logins</span>
                            </div>
                            <div class="stat-label">1</div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-number">
                                <i class="fas fa-clock"></i>
                                <span>Last Login</span>
                            </div>
                            <div class="stat-label">Just now</div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-number">
                                <i class="fas fa-shield-check"></i>
                                <span>Security Score</span>
                            </div>
                            <div class="stat-label">Good</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Activity Modal -->
<div id="activityModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3><i class="fas fa-history"></i> Account Activity</h3>
            <button class="modal-close" onclick="closeActivityModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="activity-list">
                <div class="activity-item">
                    <div class="activity-icon activity-login">
                        <i class="fas fa-sign-in-alt"></i>
                    </div>
                    <div class="activity-content">
                        <h4>Successful Login</h4>
                        <p>Logged in from this device</p>
                        <span class="activity-time">Just now</span>
                    </div>
                </div>
                
                <div class="activity-item">
                    <div class="activity-icon activity-register">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <div class="activity-content">
                        <h4>Account Created</h4>
                        <p>Your account was successfully created</p>
                        <span class="activity-time">Just now</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check session timeout
    checkSessionTimeout();
    
    // Update last activity time
    updateLastActivity();
});

function checkSessionTimeout() {
    // Check session every minute
    setInterval(function() {
        fetch('/auth/check-session')
            .then(response => response.json())
            .then(data => {
                if (!data.valid) {
                    showSessionTimeoutWarning();
                }
            })
            .catch(error => {
                console.log('Session check failed');
            });
    }, 60000); // Check every minute
}

function updateLastActivity() {
    // Update last activity every 5 minutes
    setInterval(function() {
        fetch('/auth/update-activity', { method: 'POST' })
            .catch(error => {
                console.log('Activity update failed');
            });
    }, 300000); // Update every 5 minutes
}

function showSessionTimeoutWarning() {
    const warning = document.createElement('div');
    warning.className = 'session-warning';
    warning.innerHTML = `
        <div class="warning-content">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Your session is about to expire. Refresh the page to continue.</span>
            <button onclick="location.reload()">Refresh</button>
            <button onclick="this.parentElement.parentElement.remove()">Dismiss</button>
        </div>
    `;
    document.body.appendChild(warning);
}

function showAccountActivity() {
    document.getElementById('activityModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeActivityModal() {
    document.getElementById('activityModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function enable2FA() {
    alert('Two-factor authentication would be implemented here in a production environment.');
}

function exportUserData() {
    // Create user data object
    const userData = {
        username: '{{ user.username }}',
        email: '{{ user.email }}',
        userId: '{{ user.user_id }}',
        exportDate: new Date().toISOString()
    };
    
    // Create and download JSON file
    const dataStr = JSON.stringify(userData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `user_data_${userData.username}_${Date.now()}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
}

// Close modal when clicking outside
window.addEventListener('click', function(event) {
    const activityModal = document.getElementById('activityModal');
    if (event.target === activityModal) {
        closeActivityModal();
    }
});

// Handle Escape key for modals
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeActivityModal();
    }
});
</script>
{% endblock %}
